<!DOCTYPE html>
<html>
<head>
  <title>Student Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    .action-bar {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .blur-background {
      filter: blur(5px);
      pointer-events: none;
    }
    .bulk-edit-modal .modal-dialog {
      max-width: 800px;
    }
    .student-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
    }
    .student-item {
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .student-item:last-child {
      border-bottom: none;
    }
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1100;
    }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h2 class="h5 mb-0">Student Management System</h2>
      </div>
      <div class="card-body">
        <!-- Filter Controls -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <label class="form-label">Course:</label>
            <select id="course" class="form-select">
              <option value="all">All Courses</option>
              {% for course in courses %}
                <option value="{{ course }}">{{ course }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Year:</label>
            <select id="year" class="form-select" disabled>
              <option value="all">All Years</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Semester:</label>
            <select id="semester" class="form-select" disabled>
              <option value="all">All Semesters</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Roll No:</label>
            <input type="text" id="roll_no" class="form-control" placeholder="Enter roll number">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button id="filterBtn" class="btn btn-primary w-100">
              <i class="bi bi-funnel"></i> Filter
            </button>
          </div>
        </div>
        
        <!-- Action Bar -->
        <div id="actionBar" class="action-bar" style="display: none;">
          <button id="bulkEditBtn" class="btn btn-primary">
            <i class="bi bi-pencil"></i> Alter Selected Students
          </button>
          <button id="deleteSelectedBtn" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete Selected
          </button>
          <span id="selectedCount" class="badge bg-primary ms-auto">
            0 students selected
          </span>
        </div>
        
        <!-- Results Table -->
        <div id="results" class="table-responsive" style="max-height: 500px; overflow-y: auto;">
          <!-- Results will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit Modal -->
  <div class="modal fade bulk-edit-modal" id="bulkEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Bulk Edit Students (<span id="selectedCountModal">0</span> selected)</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Only fill fields you want to update for all selected students
          </div>
          
          <div class="student-list" id="selectedStudentsList">
            <!-- Selected students will appear here -->
          </div>
          
          <form id="bulkEditForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Course</label>
                <select name="course" class="form-select">
                  <option value="">-- Keep unchanged --</option>
                  {% for course in courses %}
                    <option value="{{ course }}">{{ course }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Father Name</label>
                <input type="text" name="father_name" class="form-control"  placeholder="Leave unchanged">
              </div>
              <div class="col-md-3">
                <label class="form-label">Year</label>
                <input type="number" name="year" class="form-control" min="1" placeholder="Leave unchanged">
              </div>
              <div class="col-md-3">
                <label class="form-label">Semester</label>
                <input type="number" name="semester" class="form-control" min="1" placeholder="Leave unchanged">
              </div>
              <div class="col-md-4">
                <label class="form-label">City</label>
                <input type="text" name="city" class="form-control" placeholder="Leave unchanged">
              </div>
              <div class="col-md-4">
                <label class="form-label">State</label>
                <input type="text" name="state" class="form-control" placeholder="Leave unchanged">
              </div>
              <div class="col-md-4">
                <label class="form-label">Country</label>
                <input type="text" name="country" class="form-control" placeholder="Leave unchanged">
              </div>
              <div class="col-12">
                <label class="form-label">Address</label>
                <textarea name="address" class="form-control" rows="2" placeholder="Leave unchanged"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveBulkEdit">
            <i class="bi bi-save"></i> Update Selected Students
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="deleteMessage">Are you sure you want to delete the selected students? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function() {
      const bulkEditModal = new bootstrap.Modal('#bulkEditModal');
      const deleteModal = new bootstrap.Modal('#deleteModal');
      let selectedStudents = [];
      let csrfToken = $('input[name=csrfmiddlewaretoken]').val();

      // Initial load
      filterStudents();
      
      // Course change handler
      $('#course').change(function() {
        const course = $(this).val();
        if (course !== 'all') {
          $.get('/get_course_details/', {course_name: course}, function(data) {
            $('#year').empty().append('<option value="all">All Years</option>');
            $('#semester').empty().append('<option value="all">All Semesters</option>');
            
            data.years.forEach(year => {
              $('#year').append(`<option value="${year}">Year ${year}</option>`);
            });
            
            data.semesters.forEach(sem => {
              $('#semester').append(`<option value="${sem}">Semester ${sem}</option>`);
            });
            
            $('#year, #semester').prop('disabled', false);
          });
        } else {
          $('#year, #semester').prop('disabled', true);
        }
      });

      // Filter button click
      $('#filterBtn').click(filterStudents);
      
      // Filter students function
      function filterStudents() {
        const filters = {
          course: $('#course').val(),
          year: $('#year').val(),
          semester: $('#semester').val(),
          roll_no: $('#roll_no').val()
        };

        $('#results').html(`
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading student data...</p>
          </div>
        `);
        
        $.get('/filter_students/', filters, function(data) {
          $('#results').html(data.html);
          $('#actionBar').show();
          updateSelectedCount();
        }).fail(function() {
          $('#results').html(`
            <div class="alert alert-danger">
              Failed to load student data. Please try again.
            </div>
          `);
          $('#actionBar').hide();
        });
      }

      // Checkbox change handler
      $(document).on('change', '.student-checkbox', function() {
        const studentId = $(this).data('id');
        const studentName = $(this).closest('tr').find('td:nth-child(3)').text();
        const studentRollNo = $(this).closest('tr').find('td:nth-child(2)').text();
        
        if ($(this).is(':checked')) {
          if (!selectedStudents.some(s => s.id === studentId)) {
            selectedStudents.push({
              id: studentId,
              name: studentName,
              roll_no: studentRollNo
            });
          }
        } else {
          selectedStudents = selectedStudents.filter(s => s.id !== studentId);
        }
        updateSelectedCount();
      });

      // Update selected count display
      function updateSelectedCount() {
        const count = selectedStudents.length;
        $('#selectedCount').text(`${count} student${count !== 1 ? 's' : ''} selected`);
        $('#selectedCountModal').text(count);
      }

      // Select all checkbox
      $(document).on('change', '#selectAll', function() {
        const isChecked = $(this).is(':checked');
        $('.student-checkbox').prop('checked', isChecked).trigger('change');
      });

      // Bulk edit button
      $('#bulkEditBtn').click(function() {
        if (selectedStudents.length === 0) {
          showToast('Please select at least one student to edit', 'warning');
          return;
        }
        
        // Populate selected students list
        const studentsList = $('#selectedStudentsList');
        studentsList.empty();
        
        // Show first 5 students with "+X more" if many selected
        const maxToShow = 5;
        selectedStudents.slice(0, maxToShow).forEach(student => {
          studentsList.append(`
            <div class="student-item">
              <i class="bi bi-person"></i> ${student.roll_no} - ${student.name}
              <input type="hidden" name="student_ids[]" value="${student.id}">
            </div>
          `);
        });
        
        if (selectedStudents.length > maxToShow) {
          studentsList.append(`
            <div class="student-item text-muted">
              + ${selectedStudents.length - maxToShow} more students selected
            </div>
          `);
        }
        
        // Clear form
        $('#bulkEditForm')[0].reset();
        
        // Show modal with count in title
        $('#bulkEditModal .modal-title').html(
          `Bulk Edit Students (${selectedStudents.length} selected)`
        );
        
        bulkEditModal.show();
      });

      // Save bulk edit
      $('#saveBulkEdit').click(function() {
        const form = $('#bulkEditForm');
        const formData = form.serializeArray();
        
        // Add student IDs to form data
        selectedStudents.forEach(student => {
          formData.push({name: 'student_ids[]', value: student.id});
        });
        
        // Add CSRF token
        formData.push({name: 'csrfmiddlewaretoken', value: csrfToken});
        
        // Show loading state
        const saveBtn = $(this);
        saveBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...');
        
        $.ajax({
          url: '/bulk_update_students/',
          method: 'POST',
          data: $.param(formData),
          success: function() {
            bulkEditModal.hide();
            showToast(`${selectedStudents.length} students updated successfully`, 'success');
            filterStudents();
          },
          error: function(xhr) {
            showToast('Error updating students: ' + (xhr.responseJSON?.error || 'Please try again'), 'danger');
          },
          complete: function() {
            saveBtn.prop('disabled', false).html('<i class="bi bi-save"></i> Update Selected Students');
          }
        });
      });

      // Delete selected button
      $('#deleteSelectedBtn').click(function() {
        if (selectedStudents.length === 0) {
          showToast('Please select at least one student to delete', 'warning');
          return;
        }
        
        $('#deleteMessage').text(`Are you sure you want to delete ${selectedStudents.length} selected student${selectedStudents.length !== 1 ? 's' : ''}? This action cannot be undone.`);
        deleteModal.show();
      });

      // Confirm delete
      $('#confirmDelete').click(function() {
        const deleteBtn = $(this);
        deleteBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...');
        
        $.ajax({
          url: '/delete_students/',
          method: 'POST',
          data: {
            student_ids: selectedStudents.map(s => s.id),
            csrfmiddlewaretoken: csrfToken
          },
          success: function() {
            deleteModal.hide();
            selectedStudents = [];
            filterStudents();
            showToast('Students deleted successfully', 'success');
          },
          error: function() {
            showToast('Failed to delete students', 'danger');
          },
          complete: function() {
            deleteBtn.prop('disabled', false).html('Delete');
          }
        });
      });

      // Toast notification
      function showToast(message, type) {
        const toastId = 'toast-' + Date.now();
        const toast = $(`
          <div id="${toastId}" class="toast show align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">${message}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        `);
        
        $('.toast-container').append(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
    });
  </script>
</body>
</html>