<!DOCTYPE html>
<html>
<head>
  <title>Student Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --sidebar-width: 250px;
      --sidebar-collapsed-width: 80px;
      --header-height: 60px;
      --transition-speed: 0.3s;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
    }
    
    /* Sidebar styling */
    .sidebar {
      width: var(--sidebar-width);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background-color: #2c3e50;
      color: white;
      transition: all var(--transition-speed) ease;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
    }
    
    .sidebar-header {
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      background-color: #1a252f;
    }
    
    .sidebar-header h3 {
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .sidebar-menu {
      padding: 20px 0;
      overflow-y: auto;
      height: calc(100vh - var(--header-height));
    }
    
    .sidebar-menu .nav-link {
      color: #ecf0f1;
      border-radius: 0;
      margin: 2px 10px;
      padding: 10px 15px;
      white-space: nowrap;
      display: flex;
      align-items: center;
    }
    
    .sidebar-menu .nav-link:hover {
      background-color: #34495e;
    }
    
    .sidebar-menu .nav-link.active {
      background-color: #3498db;
    }
    
    .sidebar-menu .nav-link i {
      margin-right: 10px;
      font-size: 1.2rem;
      min-width: 25px;
    }
    
    .sidebar.collapsed .nav-link span {
      display: none;
    }
    
    .sidebar.collapsed .nav-link i {
      margin-right: 0;
      font-size: 1.4rem;
    }
    
    .sidebar.collapsed .sidebar-header h3 {
      display: none;
    }
    
    /* Main content area */
    .main-content {
      margin-left: var(--sidebar-width);
      transition: margin-left var(--transition-speed) ease;
      min-height: 100vh;
      background-color: #f5f7fa;
    }
    
    .main-content.expanded {
      margin-left: var(--sidebar-collapsed-width);
    }
    
    /* Header styling */
    .top-header {
      height: var(--header-height);
      background-color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      position: sticky;
      top: 0;
      z-index: 900;
    }
    
    .hamburger-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #2c3e50;
      cursor: pointer;
    }
    
    .user-profile {
      display: flex;
      align-items: center;
    }
    
    .user-profile img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    /* Content styling */
    .content-wrapper {
      padding: 20px;
    }
    
    /* Card styling */
    .card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    
    .card-header {
      border-radius: 10px 10px 0 0 !important;
    }
    
    /* Action bar styling */
    .action-bar {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    /* Table styling */
    .table-responsive {
      border-radius: 8px;
      overflow: hidden;
    }
    
    .table {
      margin-bottom: 0;
    }
    
    .table th {
      background-color: #f8f9fa;
      border-top: none;
    }
    
    /* Modal styling */
    .bulk-edit-modal .modal-dialog {
      max-width: 800px;
    }
    
    .student-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
    }
    
    .student-item {
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    
    .student-item:last-child {
      border-bottom: none;
    }
    
    /* Toast styling */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1100;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.show {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>Student Management</h3>
    </div>
    <div class="sidebar-menu">
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="#">
            <i class="bi bi-arrow-left"></i>
            <span>Back</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">
            <i class="bi bi-speedometer2"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'logoutdoor' %}">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">
            <i class="bi bi-gear-fill"></i>
            <span>Settings</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">
            <i class="bi bi-question-circle-fill"></i>
            <span>Help</span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <!-- Top Header -->
    <header class="top-header">
      <button class="hamburger-btn" id="hamburgerBtn">
        <i class="bi bi-list"></i>
      </button>
      <div class="user-profile">
        <img src="https://via.placeholder.com/40" alt="User Profile">
        <span>Admin User</span>
      </div>
    </header>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
      <div class="container-fluid py-4">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h2 class="h5 mb-0">Student Management System</h2>
          </div>
          <div class="card-body">
            <!-- Filter Controls -->
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <label class="form-label">Course:</label>
                <select id="course" class="form-select">
                  <option value="all">All Courses</option>
                  {% for course in courses %}
                    <option value="{{ course }}">{{ course }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Year:</label>
                <select id="year" class="form-select" disabled>
                  <option value="all">All Years</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Semester:</label>
                <select id="semester" class="form-select" disabled>
                  <option value="all">All Semesters</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Roll No:</label>
                <input type="text" id="roll_no" class="form-control" placeholder="Enter roll number">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button id="filterBtn" class="btn btn-primary w-100">
                  <i class="bi bi-funnel"></i> Filter
                </button>
              </div>
            </div>
            
            <!-- Action Bar -->
            <div id="actionBar" class="action-bar" style="display: none;">
              <button id="bulkEditBtn" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Alter Selected Students
              </button>
              <button id="deleteSelectedBtn" class="btn btn-danger">
                <i class="bi bi-trash"></i> Delete Selected
              </button>
              <span id="selectedCount" class="badge bg-primary ms-auto">
                0 students selected
              </span>
            </div>
            
            <!-- Results Table -->
            <div id="results" class="table-responsive" style="max-height: 500px; overflow-y: auto;">
              <!-- Results will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit Modal -->
  <div class="modal fade bulk-edit-modal" id="bulkEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Bulk Edit Students (<span id="selectedCountModal">0</span> selected)</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Only fill fields you want to update for all selected students
          </div>
          
          <div class="student-list" id="selectedStudentsList">
            <!-- Selected students will appear here -->
          </div>
          
          <form id="bulkEditForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Course</label>
                <select name="course" class="form-select">
                  <option value="">-- Keep unchanged --</option>
                  {% for course in courses %}
                    <option value="{{ course }}">{{ course }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Father Name</label>
                <input type="text" name="father_name" class="form-control"  placeholder="Leave unchanged">
              </div>
              <div class="col-md-3">
                <label class="form-label">Year</label>
                <input type="number" name="year" class="form-control" min="1" placeholder="Leave unchanged">
              </div>
              <div class="col-md-3">
                <label class="form-label">Semester</label>
                <input type="number" name="semester" class="form-control" min="1" placeholder="Leave unchanged">
              </div>
              <div class="col-md-4">
                <label class="form-label">City</label>
                <input type="text" name="city" class="form-control" placeholder="Leave unchanged">
              </div>
              <div class="col-md-4">
                <label class="form-label">State</label>
                <input type="text" name="state" class="form-control" placeholder="Leave unchanged">
              </div>
              <div class="col-md-4">
                <label class="form-label">Country</label>
                <input type="text" name="country" class="form-control" placeholder="Leave unchanged">
              </div>
              <div class="col-12">
                <label class="form-label">Address</label>
                <textarea name="address" class="form-control" rows="2" placeholder="Leave unchanged"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveBulkEdit">
            <i class="bi bi-save"></i> Update Selected Students
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="deleteMessage">Are you sure you want to delete the selected students? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function() {
      const bulkEditModal = new bootstrap.Modal('#bulkEditModal');
      const deleteModal = new bootstrap.Modal('#deleteModal');
      let selectedStudents = [];
      let csrfToken = $('input[name=csrfmiddlewaretoken]').val();
      let sidebarCollapsed = false;

      // Toggle sidebar
      $('#hamburgerBtn').click(function() {
        sidebarCollapsed = !sidebarCollapsed;
        $('#sidebar').toggleClass('collapsed');
        $('#mainContent').toggleClass('expanded');
        
        // Change icon based on state
        const icon = $(this).find('i');
        if (sidebarCollapsed) {
          icon.removeClass('bi-list').addClass('bi-justify');
        } else {
          icon.removeClass('bi-justify').addClass('bi-list');
        }
      });

      // Mobile sidebar toggle
      function handleMobileSidebar() {
        if ($(window).width() <= 768) {
          $('#sidebar').removeClass('collapsed');
          $('#mainContent').removeClass('expanded');
          $('#hamburgerBtn i').removeClass('bi-justify').addClass('bi-list');
          sidebarCollapsed = false;
        }
      }

      // Initial check for mobile
      handleMobileSidebar();
      
      // Resize handler
      $(window).resize(handleMobileSidebar);

      // Initial load
      filterStudents();
      
      // Course change handler
      $('#course').change(function() {
        const course = $(this).val();
        if (course !== 'all') {
          $.get('/get_course_details/', {course_name: course}, function(data) {
            $('#year').empty().append('<option value="all">All Years</option>');
            $('#semester').empty().append('<option value="all">All Semesters</option>');
            
            data.years.forEach(year => {
              $('#year').append(`<option value="${year}">Year ${year}</option>`);
            });
            
            data.semesters.forEach(sem => {
              $('#semester').append(`<option value="${sem}">Semester ${sem}</option>`);
            });
            
            $('#year, #semester').prop('disabled', false);
          });
        } else {
          $('#year, #semester').prop('disabled', true);
        }
      });

      // Filter button click
      $('#filterBtn').click(filterStudents);
      
      // Filter students function
      function filterStudents() {
        const filters = {
          course: $('#course').val(),
          year: $('#year').val(),
          semester: $('#semester').val(),
          roll_no: $('#roll_no').val()
        };

        $('#results').html(`
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading student data...</p>
          </div>
        `);
        
        $.get('/filter_students/', filters, function(data) {
          $('#results').html(data.html);
          $('#actionBar').show();
          updateSelectedCount();
        }).fail(function() {
          $('#results').html(`
            <div class="alert alert-danger">
              Failed to load student data. Please try again.
            </div>
          `);
          $('#actionBar').hide();
        });
      }

      // Checkbox change handler
      $(document).on('change', '.student-checkbox', function() {
        const studentId = $(this).data('id');
        const studentName = $(this).closest('tr').find('td:nth-child(3)').text();
        const studentRollNo = $(this).closest('tr').find('td:nth-child(2)').text();
        
        if ($(this).is(':checked')) {
          if (!selectedStudents.some(s => s.id === studentId)) {
            selectedStudents.push({
              id: studentId,
              name: studentName,
              roll_no: studentRollNo
            });
          }
        } else {
          selectedStudents = selectedStudents.filter(s => s.id !== studentId);
        }
        updateSelectedCount();
      });

      // Update selected count display
      function updateSelectedCount() {
        const count = selectedStudents.length;
        $('#selectedCount').text(`${count} student${count !== 1 ? 's' : ''} selected`);
        $('#selectedCountModal').text(count);
      }

      // Select all checkbox
      $(document).on('change', '#selectAll', function() {
        const isChecked = $(this).is(':checked');
        $('.student-checkbox').prop('checked', isChecked).trigger('change');
      });

      // Bulk edit button
      $('#bulkEditBtn').click(function() {
        if (selectedStudents.length === 0) {
          showToast('Please select at least one student to edit', 'warning');
          return;
        }
        
        // Populate selected students list
        const studentsList = $('#selectedStudentsList');
        studentsList.empty();
        
        // Show first 5 students with "+X more" if many selected
        const maxToShow = 5;
        selectedStudents.slice(0, maxToShow).forEach(student => {
          studentsList.append(`
            <div class="student-item">
              <i class="bi bi-person"></i> ${student.roll_no} - ${student.name}
              <input type="hidden" name="student_ids[]" value="${student.id}">
            </div>
          `);
        });
        
        if (selectedStudents.length > maxToShow) {
          studentsList.append(`
            <div class="student-item text-muted">
              + ${selectedStudents.length - maxToShow} more students selected
            </div>
          `);
        }
        
        // Clear form
        $('#bulkEditForm')[0].reset();
        
        // Show modal with count in title
        $('#bulkEditModal .modal-title').html(
          `Bulk Edit Students (${selectedStudents.length} selected)`
        );
        
        bulkEditModal.show();
      });

      // Save bulk edit
      $('#saveBulkEdit').click(function() {
        const form = $('#bulkEditForm');
        const formData = form.serializeArray();
        
        // Add student IDs to form data
        selectedStudents.forEach(student => {
          formData.push({name: 'student_ids[]', value: student.id});
        });
        
        // Add CSRF token
        formData.push({name: 'csrfmiddlewaretoken', value: csrfToken});
        
        // Show loading state
        const saveBtn = $(this);
        saveBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...');
        
        $.ajax({
          url: '/bulk_update_students/',
          method: 'POST',
          data: $.param(formData),
          success: function() {
            bulkEditModal.hide();
            showToast(`${selectedStudents.length} students updated successfully`, 'success');
            filterStudents();
          },
          error: function(xhr) {
            showToast('Error updating students: ' + (xhr.responseJSON?.error || 'Please try again'), 'danger');
          },
          complete: function() {
            saveBtn.prop('disabled', false).html('<i class="bi bi-save"></i> Update Selected Students');
          }
        });
      });

      // Delete selected button
      $('#deleteSelectedBtn').click(function() {
        if (selectedStudents.length === 0) {
          showToast('Please select at least one student to delete', 'warning');
          return;
        }
        
        $('#deleteMessage').text(`Are you sure you want to delete ${selectedStudents.length} selected student${selectedStudents.length !== 1 ? 's' : ''}? This action cannot be undone.`);
        deleteModal.show();
      });

      // Confirm delete
      $('#confirmDelete').click(function() {
        const deleteBtn = $(this);
        deleteBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...');
        
        $.ajax({
          url: '/delete_students/',
          method: 'POST',
          data: {
            student_ids: selectedStudents.map(s => s.id),
            csrfmiddlewaretoken: csrfToken
          },
          success: function() {
            deleteModal.hide();
            selectedStudents = [];
            filterStudents();
            showToast('Students deleted successfully', 'success');
          },
          error: function() {
            showToast('Failed to delete students', 'danger');
          },
          complete: function() {
            deleteBtn.prop('disabled', false).html('Delete');
          }
        });
      });

      // Toast notification
      function showToast(message, type) {
        const toastId = 'toast-' + Date.now();
        const toast = $(`
          <div id="${toastId}" class="toast show align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">${message}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        `);
        
        $('.toast-container').append(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
    });
  </script>
</body>
</html>