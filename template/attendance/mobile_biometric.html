{% extends 'attendance/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card border-0 shadow-lg">
            <div class="card-body p-5 text-center">
                <!-- Fingerprint Animation -->
                <div class="fingerprint-scan mb-4">
                    <div class="fingerprint">
                        <div class="fingerprint-inner"></div>
                    </div>
                    <div class="scan-line"></div>
                </div>
                
                <h2 class="text-primary">
                    <i class="bi bi-fingerprint"></i>
                    Mobile Fingerprint Verification
                </h2>
                
                <div class="alert alert-info border-0 mt-4">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-phone fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">Device Detected: Mobile</h5>
                            <p class="mb-1">
                                College ID: <strong>{{ college_id }}</strong>
                            </p>
                            <p class="mb-0">
                                Please use your device's fingerprint scanner to verify identity
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="card border-primary mt-4">
                    <div class="card-body">
                        <h5><i class="bi bi-list-check"></i> Instructions:</h5>
                        <ol class="text-start">
                            <li>Ensure your finger is clean and dry</li>
                            <li>Place your finger on the fingerprint sensor</li>
                            <li>Hold until device vibrates or beeps</li>
                            <li>Do not remove finger too quickly</li>
                            <li>If fails, clean sensor and try again</li>
                        </ol>
                    </div>
                </div>
                
                <!-- Simulated Mobile Interface -->
                <div class="mobile-interface mt-4">
                    <div class="mobile-screen">
                        <div class="mobile-header">
                            <i class="bi bi-phone"></i> Mobile Device
                        </div>
                        <div class="mobile-body">
                            <div class="fingerprint-icon">
                                <i class="bi bi-fingerprint"></i>
                            </div>
                            <p class="mt-3">Touch the fingerprint sensor</p>
                            <button class="btn btn-outline-primary mt-2" onclick="simulateFingerprint()">
                                <i class="bi bi-fingerprint"></i> Simulate Scan
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Status Messages -->
                <div id="verificationStatus" class="mt-4" style="display: none;">
                    <div class="alert" id="statusAlert">
                        <!-- Status will appear here -->
                    </div>
                </div>
                
                <!-- Alternative Options -->
                <div class="mt-4">
                    <p class="text-muted">Having trouble with fingerprint?</p>
                    <div class="btn-group" role="group">
                        <a href="{% url 'verify_college_id' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Use Different ID
                        </a>
                        <button class="btn btn-outline-warning" onclick="usePINInstead()">
                            <i class="bi bi-key"></i> Use PIN Instead
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Fingerprint Animation */
.fingerprint-scan {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto;
}

.fingerprint {
    width: 100%;
    height: 100%;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50,20 C65,20 75,30 75,45 C75,60 65,70 50,70 C35,70 25,60 25,45 C25,30 35,20 50,20 Z' fill='none' stroke='%23667eea' stroke-width='2'/%3E%3Cpath d='M30,50 C30,65 40,75 55,75 C70,75 80,65 80,50' fill='none' stroke='%23667eea' stroke-width='2'/%3E%3Cpath d='M40,55 C40,65 45,70 55,70 C65,70 70,65 70,55' fill='none' stroke='%23667eea' stroke-width='2'/%3E%3C/svg%3E") no-repeat center;
    background-size: contain;
}

.fingerprint-inner {
    width: 80px;
    height: 80px;
    position: absolute;
    top: 20px;
    left: 20px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80'%3E%3Cpath d='M40,15 C50,15 55,20 55,30 C55,40 50,45 40,45 C30,45 25,40 25,30 C25,20 30,15 40,15 Z' fill='none' stroke='%23764ba2' stroke-width='2'/%3E%3C/svg%3E") no-repeat center;
    background-size: contain;
}

.scan-line {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, transparent, #667eea, transparent);
    animation: scan 2s infinite linear;
}

@keyframes scan {
    0% { top: 0; }
    100% { top: 100%; }
}

/* Mobile Interface */
.mobile-interface {
    border: 2px solid #dee2e6;
    border-radius: 20px;
    padding: 20px;
    background: #f8f9fa;
    max-width: 300px;
    margin: 0 auto;
}

.mobile-screen {
    border: 2px solid #6c757d;
    border-radius: 10px;
    background: white;
    overflow: hidden;
}

.mobile-header {
    background: #6c757d;
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: bold;
}

.mobile-body {
    padding: 30px 20px;
    text-align: center;
}

.fingerprint-icon {
    width: 80px;
    height: 80px;
    background: #f0f4ff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    font-size: 2.5rem;
    color: #667eea;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
</style>

<script>
let isScanning = false;

function simulateFingerprint() {
    if (isScanning) return;
    
    isScanning = true;
    const statusDiv = document.getElementById('verificationStatus');
    const statusAlert = document.getElementById('statusAlert');
    
    // Show scanning
    statusAlert.className = 'alert alert-info';
    statusAlert.innerHTML = `
        <i class="bi bi-hourglass-split"></i>
        <strong>Scanning...</strong> Please keep your finger on the sensor.
    `;
    statusDiv.style.display = 'block';
    
    // Simulate scan delay
    setTimeout(() => {
        // 80% success rate simulation
        const isSuccess = Math.random() > 0.2;
        
        if (isSuccess) {
            statusAlert.className = 'alert alert-success';
            statusAlert.innerHTML = `
                <i class="bi bi-check-circle-fill"></i>
                <strong>Success!</strong> Fingerprint verified. Marking attendance...
            `;
            
            // Send verification to server
            sendVerificationToServer(true);
        } else {
            statusAlert.className = 'alert alert-danger';
            statusAlert.innerHTML = `
                <i class="bi bi-x-circle-fill"></i>
                <strong>Failed!</strong> Fingerprint not recognized. Please try again.
            `;
            
            isScanning = false;
            
            // Show retry button
            setTimeout(() => {
                const retryBtn = document.createElement('button');
                retryBtn.className = 'btn btn-warning btn-sm mt-2';
                retryBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Try Again';
                retryBtn.onclick = simulateFingerprint;
                statusAlert.appendChild(retryBtn);
            }, 1000);
        }
    }, 2000);
}

function sendVerificationToServer(success) {
    if (!success) return;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch("{% url 'api_mobile_verify' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            college_id: '{{ college_id }}',
            biometric_token: 'simulated_fingerprint_token_' + Date.now(),
            device_id: 'simulated_device_' + navigator.userAgent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to success page
            window.location.href = "{% url 'home' %}?success=true";
        } else {
            document.getElementById('statusAlert').className = 'alert alert-danger';
            document.getElementById('statusAlert').innerHTML = `
                <i class="bi bi-x-circle-fill"></i>
                <strong>Server Error:</strong> ${data.message}
            `;
            isScanning = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        isScanning = false;
    });
}

function usePINInstead() {
    if (confirm('Switch to PIN verification? You will be redirected to laptop mode.')) {
        window.location.href = "{% url 'laptop_pin_verification' %}";
    }
}

// Auto detect if actually on mobile
function detectMobile() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (!isMobile) {
        document.querySelector('.mobile-interface').innerHTML += `
            <div class="alert alert-warning mt-3">
                <i class="bi bi-exclamation-triangle"></i>
                You seem to be on a desktop. For real fingerprint scanning, please use a mobile device.
            </div>
        `;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', detectMobile);
</script>

{% endblock %}
