<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Geolocation with Full Address</title>
</head>

<body>
    <h1>Get My Full Location</h1>
    <p id="output"></p>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function getLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation Not Supported!')
            } else if (navigator.geolocation) {
                document.getElementById('output').innerHTML = 'Fetching location...'
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const accuracy = position.coords.accuracy;

                        console.log(lat, lon, accuracy)

                        // Display coordinates first
                        document.getElementById("output").innerHTML = `Coordinates: ${lat}, ${lon}<br>Fetching full address...`;

                        fetch("/save-location/",{
                            method:'POST',
                            headers:{
                                "Content-Type":"application/json",
                                "X-CSRFToken":getCookie("csrftoken")
                            },
                            body:JSON.stringify({
                                lat: lat,
                                lon:lon,
                                accuracy:accuracy
                            })
                        })
                        .then(res => res.json())
                        .then(data =>{
                            console.log(data);
                        })
                        // Reverse geocoding using Nominatim (free, no API key needed)
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.display_name) {
                                    document.getElementById("output").innerHTML =
                                        `Coordinates: ${lat}, ${lon}<br>Full Address: ${data.display_name}`;
                                } else {
                                    document.getElementById("output").innerHTML = "Address not found.";
                                }
                            })
                            .catch(error => {
                                document.getElementById("output").innerHTML = "Error fetching address.";
                                console.error(error);
                            });
                    },
                    function (error) {
                        let message = "";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message = "Permission denied.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message = "Location unavailable.";
                                break;
                            case error.TIMEOUT:
                                message = "Request timed out.";
                                break;
                            default:
                                message = "Unknown error.";
                        }
                        document.getElementById("output").innerHTML = message;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                document.getElementById("output").innerHTML = "Geolocation not supported.";
            }
        }
        getLocation();
    </script>
</body>

</html>