<!DOCTYPE html>
<html lang="en">

<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Attendance System - Bulk Student Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="{% static 'css/bulkActions/student.css' %}">
</head>

<div>
    {% include "header.html" %}
    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1 class="animate__animated animate__fadeInDown">Student Management System</h1>
            <p class="animate__animated animate__fadeInUp">Manage student records efficiently and effectively</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="f-container">
        <div class="enroll-container">
            <div class="enroll-header">
                <h3>Bulk Student Management</h3>
                <p class="mb-0">Filter and manage multiple students at once</p>
            </div>

            <!-- Messages will appear here -->
            <div id="messageContainer" style="display: none;"></div>
            <!-- Alert Messages -->
            {% if messages %}
            <div id="alertContainer">
                {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}">
                    <i
                        class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %}"></i>
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="filter-section">
                <div class="filter-group">
                    <label for="course"><i class="fas fa-book"></i> Course:</label>
                    <select id="course" class="form-select">
                        <option value="all" selected>All Courses</option>
                        {% for course in courses %}
                        <option value="{{ course.course_id }}">{{ course.name }} with {{ course.level.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="year"><i class="fas fa-calendar-alt"></i> Year:</label>
                    <select id="year" class="form-select" disabled>
                        <option value="all" selected>All Years</option>
                        <!-- result will loaded here -->
                    </select>
                </div>

                <div class="filter-group">
                    <label for="semester"><i class="fas fa-calendar-check"></i> Semester:</label>
                    <select id="semester" class="form-select" disabled>
                        <option value="all" selected>All Semesters</option>
                        <!-- result will loaded here -->
                    </select>
                </div>

                <div class="filter-group">
                    <label for="college_id"><i class="fas fa-id-card"></i> College ID:</label>
                    <input type="text" id="college_id" class="form-control" placeholder="Enter College ID">
                </div>

                <div class="filter-group">
                    <button id="filterBtn" class="btn-filter w-100">
                        <i class="fas fa-filter"></i> Filter Students
                    </button>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="bulk-actions">
                <input type="checkbox" id="selectAll" class="bulk-select">
                <label for="selectAll">Select All</label>
                <button class="btn btn-primary btn-sm" id="editSelected">
                    <i class="fas fa-edit"></i> Edit Selected
                </button>
                <button class="btn btn-danger btn-sm" id="deleteSelected">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
                <button class="btn btn-success btn-sm" id="exportSelected">
                    <i class="fas fa-file-export"></i> Export Selected
                </button>
            </div>

            <div class="results-section">
                <div id="loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading student data...</p>
                </div>
                <!--  Ajax Pagination -->
                <div id="results">
                    <div class="table-responsive">
                        <table class="student-table" id="student-table">
                            <thead>
                                <tr>
                                    <th>Select</th>
                                    <th>Profile</th>
                                    <th>College ID</th>
                                    <th>Name</th>
                                    <th>Father's Name</th>
                                    <th>Course</th>
                                    <th>Year/Semester</th>
                                    <th>Phone 1</th>
                                    <th>Phone 2</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody">
                                {% for student in page_obj %}
                                <tr id="student-{{ student.college_id }}">
                                    <td><input type="checkbox" id="student-checkbox" class="student-checkbox"
                                            data-id="{{ student.college_id }}"></td>
                                    <td>
                                        {% if student.profile_picture %}
                                        <img src="{{ student.profile_picture.url }}" class="avatar" alt="Student">
                                        {% else %}
                                        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
                                            class="avatar" alt="Student">
                                        {% endif %}
                                    </td>
                                    <td>{{ student.college_id }}</td>
                                    <td>{{ student.name }} {{ student.last_name }}</td>
                                    <td>{{ student.father_name }}</td>
                                    <td>{{ student.course.code }} - {{ student.course.level }}</td>
                                    <td>{{ student.year }} Year / {{ student.semester }} Sem
                                    </td>
                                    <td>{{ student.phone }}</td>
                                    <td>{{ student.other_phone_no }}</td>
                                    <td class="action-buttons">
                                        <a href="#" class="btn-action btn-view" data-id="{{ student.college_id }}">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a class="btn-action btn-edit" data-id="{{ student.college_id }}">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn-action btn-delete" data-id="{{ student.college_id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination will be handled via AJAX -->
                    <div class="pagination" id="pagination">
                        <button id="prev-btn"
                            data-page="{% if page_obj.has_previous %}{{ page_obj.previous_page_number }}{% else %}1{% endif %}"
                            {% if not page_obj.has_previous %}disabled{% endif %}>Previous</button>
                        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                        <button id="next-btn"
                            data-page="{% if page_obj.has_next %}{{ page_obj.next_page_number }}{% else %}{{ page_obj.paginator.num_pages }}{% endif %}"
                            {% if not page_obj.has_next %}disabled{% endif %}>Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selected Students Modal -->
    <div class="modal-overlay" id="selectedStudentsModal" style="display: none;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Selected Students</h5>
                    <button type="button" id="closeBtn" class="btn-close btn-close-white close-selected-modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="student-table-container">
                        <div class="container-content">
                            <div class="table-responsive">
                                <table class="student-table">
                                    <thead>
                                        <tr>
                                            <th>Profile</th>
                                            <th>College ID</th>
                                            <th>Name</th>
                                            <th>Father's Name</th>
                                            <th>Document</th>
                                        </tr>
                                    </thead>
                                    <tbody id="selectedStudentsTableBody">
                                        <!-- Selected students will appear here -->

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-selected-modal" id="closeBtn"
                        style="margin-right: 5px;">Close</button>
                    <button type="button" id="submit-selected-btn" class="btn btn-primary submit-selected-btn">
                        <i class="fas fa-paper-plane"></i> Submit Selected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog modal-confirm">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="icon-box">
                        <i class="fas fa-exclamation"></i>
                    </div>
                    <h4 class="modal-title">Are you sure?</h4>
                    <button type="button" class="btn-close close-delete-modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-center">Do you really want to delete this record? This process cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary cancel-delete">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger confirm-delete">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // for selecting checkboxes
        let selectAll = document.querySelector('#selectAll');
        let list = [];

        // Function to refresh student checkboxes reference
        function refreshStudentCheckboxes() {
            studentcheckbox = document.querySelectorAll('.student-checkbox');
            attachCheckboxEvents();
        }

        // Function to attach events to checkboxes
        function attachCheckboxEvents() {
            studentcheckbox.forEach(one => {
                // Remove existing event listeners to avoid duplicates
                one.replaceWith(one.cloneNode(true));
            });

            // Refresh reference after cloning
            studentcheckbox = document.querySelectorAll('.student-checkbox');

            studentcheckbox.forEach(one => {
                one.addEventListener('change', function () {
                    let checked_college_id = this.getAttribute('data-id');
                    if (this.checked) {
                        list.push(checked_college_id);
                    } else {
                        list = list.filter(x => x !== checked_college_id);
                    }
                    console.log("Updated list:", list);
                });
            });
        }

        // Select All functionality
        selectAll.addEventListener('change', function () {
            refreshStudentCheckboxes(); // Refresh reference

            if (selectAll.checked) {
                list = [];
                studentcheckbox.forEach(one => {
                    let checked_college_id = one.getAttribute('data-id');
                    one.checked = true;
                    list.push(checked_college_id);
                });
            } else {
                studentcheckbox.forEach(one => {
                    one.checked = false;
                });
                list = [];
            }
            console.log("Select All list:", list);
        });

        // Initial attachment of events
        document.addEventListener("DOMContentLoaded", function () {
            refreshStudentCheckboxes();

            function loadPage(page) {
                const college_id = document.getElementById("college_id").value;
                console.log({ course: course.value, year: year.value, semester: semester.value, college_id });

                fetch(`?page=${page}&course=${course.value}&year=${year.value}&semester=${semester.value}&college_id=${college_id}`, {
                    headers: {
                        "x-requested-with": "XMLHttpRequest"
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        let table = document.querySelector("#studentTableBody");
                        table.innerHTML = "";  // CLEAR previous rows

                        data.students.forEach(detail => {
                            table.innerHTML += `
                <tr id="student-${detail.college_id}">
                    <td><input type="checkbox" class="student-checkbox" data-id="${detail.college_id}"></td>
                    <td>
                        ${detail.image ?
                                    `<img src="${detail.image}" class="avatar">` :
                                    `<img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="avatar">`}
                    </td>
                    <td>${detail.college_id}</td>
                    <td>${detail.name}</td>
                    <td>${detail.father_name}</td>
                    <td>${detail.course}</td>
                    <td>${detail.class}</td>
                    <td>${detail.phone1}</td>
                    <td>${detail.phone2}</td>
                    <td class="action-buttons">
                        <a href="#" class="btn-action btn-view" data-id="${detail.college_id}">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a class="btn-action btn-edit" data-id="${detail.college_id}">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="btn-action btn-delete" data-id="${detail.college_id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
                        });

                        // Refresh checkboxes after loading new data
                        refreshStudentCheckboxes();

                        // Reset select all checkbox
                        selectAll.checked = false;

                        // pagination update
                        let prev = document.getElementById("prev-btn");
                        let next = document.getElementById("next-btn");

                        prev.dataset.page = data.page_number - 1;
                        next.dataset.page = data.page_number + 1;

                        prev.disabled = !data.has_prev;
                        next.disabled = !data.has_next;

                        document.querySelector("#pagination span").innerText =
                            `Page ${data.page_number} of ${data.total_page}`;
                    })
                    .catch(error => {
                        localStorage.setItem('Message', error);
                        localStorage.setItem('status', 'danger');
                        location.reload()
                    });
            }

            // Events
            document.getElementById("prev-btn").addEventListener("click", function () {
                loadPage(this.dataset.page);
            });

            document.getElementById("next-btn").addEventListener("click", function () {
                loadPage(this.dataset.page);
            });

            document.getElementById("filterBtn").addEventListener("click", function () {
                loadPage(1);
            });
        });

        // for adding option semster and year
        course.addEventListener('change', function () {
            courseHandler.call(this, year, semester);
        });

        function courseHandler(yearEl, semesterEl) {
            const course_id = this.value;
            if (course_id !== "") {
                yearEl.disabled = false;
                semesterEl.disabled = false;
                semesterYear(course_id, yearEl, semesterEl);
                // Reset batch and fees when course changes
            } else {
                yearEl.disabled = true;
                semesterEl.disabled = true;
                yearEl.innerHTML = "<option value='all' selected disabled>Select Year</option>";
                semesterEl.innerHTML = "<option value='all' selected disabled>Select Semester</option>";
            }
            console.log(course_id)
        }

        function semesterYear(course_id, yearEl, semesterEl) {
            fetch("/semester&year/", {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({ 'course_id': course_id })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        localStorage.setItem('Message', data.error);
                        localStorage.setItem('status', 'danger');
                        location.reload()
                    } else {
                        // Populate Year options
                        let yearOptions = "<option value='all' selected>Select Year</option>";
                        data.year.forEach(value => {
                            yearOptions += `<option value="${value}">${value} Year</option>`;
                        });
                        yearEl.innerHTML = yearOptions;

                        // Populate Semester options
                        let semOptions = "<option value='all' selected>Select Semester</option>";
                        data.semester.forEach(value => {
                            semOptions += `<option value="${value}">${value} Semester</option>`;
                        });
                        semesterEl.innerHTML = semOptions;
                    }
                })
                .catch(err => {
                    localStorage.setItem('Message', err);
                    localStorage.setItem('status', 'danger');
                    location.reload()
                });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // for take data of checked students
        const editSelected = document.querySelector('#editSelected');
        const selectedStudentsModal = document.querySelector('#selectedStudentsModal');

        editSelected.addEventListener('click', () => {
            fetch("/SelectedEditData/", {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({ 'SelectedList': list })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.log(data.error);
                        localStorage.setItem('Message', data.error);
                        localStorage.setItem('status', 'danger');
                        location.reload()
                    } else {
                        selectedStudentsModal.style.display = 'block';
                        const selectedStudentsTableBody = document.querySelector('#selectedStudentsTableBody');
                        selectedStudentsTableBody.innerHTML = '';
                        data.data.forEach(one => {

                            selectedStudentsTableBody.innerHTML += `
    <tr data-id="${one.college_id}">
        <td>
            ${one.profile ?
                                    `<img src="${one.profile}" class="avatar" alt="Student">` :
                                    `<img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="avatar" alt="Student">`
                                }
        </td>

        <!-- College ID (DISABLED INPUT) -->
        <td>
            <input type="text" id='collegeID' value="${one.college_id}" disabled>
        </td>

        <!-- Name (EDITABLE) -->
        <td>
            <input type="text"  value="${one.name}" disabled>
        </td>

        <!-- Father Name (EDITABLE) -->
        <td>
            <input type="text" value="${one.father_name}" disabled>
        </td>

        <!-- Permission (TOGGLE SWITCH) -->
        <td>
            <label class="toggle-switch">
                <input type="checkbox" class="toggle-input" name="permission_${one.college_id}" 
                    ${one.permission === true ? "checked" : ""}>
                <span class="toggle-slider"></span>
                <span class="toggle-labels">
                    <span class="toggle-on">ON</span>
                    <span class="toggle-off">OFF</span>
                </span>
            </label>
        </td>
    </tr>`
                        })

                    }
                })
        })

        // for handling close btn 
        let closeBtn = document.querySelectorAll('#closeBtn');
        closeBtn.forEach(oneClick => {
            closeBtnfunction(oneClick);
        })

        function closeBtnfunction(one) {
            one.addEventListener('click', () => {
                selectedStudentsModal.style.display = 'none';
                disablestudentchecked();
            })
        }
        function disablestudentchecked() {
            list = []
            selectAll.checked = false
            studentcheckbox.forEach(single => {
                single.disabled = false;
                single.checked = false;
            })
        }
        selectedStudentsModal.addEventListener('click', (e) => {
            if (e.target === selectedStudentsModal) {
                selectedStudentsModal.style.display = 'none';
                disablestudentchecked();
            }
        })
        // send the input for editselected
        let editSelectedBtn = document.querySelector('#submit-selected-btn')

        let collegeID = [];
        let permission = [];
        editSelectedBtn.addEventListener('click', () => {
            const collegeIDvalue = document.querySelectorAll('#collegeID');
            collegeIDvalue.forEach(el1 => {
                collegeID.push(el1.value);
            })
            const isclicked = document.querySelectorAll('.toggle-input');
            isclicked.forEach(el2 => {
                permission.push(el2.checked ? 'Yes' : 'No');
            })

            fetch('/EditSelectedSubmit/', {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({ 'collegeID': collegeID, 'permission': permission })
            })
                .then(res => res.json())
                .then(data => {

                    if (data.error) {
                        console.log(data.error);
                        localStorage.setItem('Message', data.error);
                        localStorage.setItem('status', 'danger')
                        location.reload();
                    } else {
                        console.log(data.success)
                        localStorage.setItem('Message', data.success);
                        localStorage.setItem('status', 'success')
                        location.reload();
                    }
                })
        })

        window.onload = function () {
            let msg = localStorage.getItem('Message');
            let status = localStorage.getItem('status');

            // YEH CONDITION ADD KARO - Only show message if not null/empty
            if (msg && msg !== 'null' && msg.trim() !== '') {
                messageShow.style.display = 'block';
                showMessage(msg, status);
            }

            setTimeout(() => {
                localStorage.removeItem('Message');
                localStorage.removeItem('status');
            }, 5000)
        }

        // for showing messages
        let messageShow = document.querySelector('#messageContainer')
        function showMessage(message, type) {
            // Additional check - if message is null/empty, don't show
            if (!message || message === 'null' || message.trim() === '') {
                if (messageShow) {
                    messageShow.innerHTML = '';
                    messageShow.style.display = 'none';
                }
                return;
            }

            const alertClass = type === 'danger' ? 'alert-danger' : 'alert-success';
            if (messageShow !== null) {
                messageShow.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert" id="alertMessage">
                ${message}
                <button type="button" class="btn-close" id="closeMessageBtn" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            };

            // Auto-remove message after 5 seconds
            setTimeout(() => {
                if (messageShow) {
                    messageShow.innerHTML = '';
                    messageShow.style.display = 'none';
                }
            }, 5000);
        };
    </script>
    </body>

</html>