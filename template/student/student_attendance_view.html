<!DOCTYPE html>
<html lang="en">

<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="{% static 'css/attendance/studentView.css' %}">
</head>

<body>
    {% include "header.html" %}

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1 class="animate__animated animate__fadeInDown">My Attendance</h1>
            <p class="animate__animated animate__fadeInUp">Track and monitor your attendance records</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="f-container">
        <div class="enroll-container">
            <div class="enroll-header">
                <h3>Attendance Overview</h3>
                <p class="mb-0">Detailed view of your attendance records</p>
            </div>

            <!-- Messages will appear here -->
            <div id="messageContainer"></div>

            <!-- Alert Messages -->
            {% if messages %}
            <div id="alertContainer">
                {% for message in messages %}
                <div
                    class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
                    <i
                        class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="student-info">
                <div class="info-card">
                    <h3><i class="fas fa-user"></i> Student Name</h3>
                    <p>{{ student.name }} {{ student.last_name }}</p>
                </div>
                <div class="info-card">
                    <h3><i class="fas fa-id-card"></i> College ID</h3>
                    <p>{{ student.college_id }}</p>
                </div>
                <div class="info-card">
                    <h3><i class="fas fa-book"></i> Course</h3>
                    <p>{{ student.course }}</p>
                </div>
                <div class="info-card">
                    <h3><i class="fas fa-calendar-alt"></i> Year/Semester</h3>
                    <p>Year {{ student.year }} / Sem {{ student.semester }}</p>
                </div>
            </div>

            <div class="summary-cards">
                <div class="summary-card">
                    <h3><i class="fas fa-chalkboard-teacher"></i> Total Lectures</h3>
                    <p id="total-lectures">0</p>
                </div>
                <div class="summary-card">
                    <h3><i class="fas fa-check-circle"></i> Present</h3>
                    <p id="present-count">0</p>
                </div>
                <div class="summary-card">
                    <h3><i class="fas fa-times-circle"></i> Absent</h3>
                    <p id="absent-count">0</p>
                </div>
                <div class="summary-card">
                    <h3><i class="fas fa-chart-line"></i> Attendance %</h3>
                    <p id="attendance-percent">0%</p>
                </div>
                <div class="summary-card">
                    <h3><i class="fas fa-chart-line"></i> Attendance %</h3>
                    <p id="attendance-percent">0%</p>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-group">
                    <label for="course"><i class="fas fa-book"></i> Course:</label>
                    <select id="course" class="form-select">
                        <option value="all">All Courses</option>
                        <option value="{{ student.course }}" selected>{{ student.course }}</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="month"><i class="fas fa-calendar"></i> Month:</label>
                    <select id="month" class="form-select">
                        <option value="all">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="year"><i class="fas fa-calendar-alt"></i> Year:</label>
                    <select id="year" class="form-select">
                        <option value="all">All Years</option>
                        {% for year in years %}
                        <option value="{{ year }}" {% if year==current_year %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="status"><i class="fas fa-info-circle"></i> Status:</label>
                    <select id="status" class="form-select">
                        <option value="all">All Status</option>
                        <option value="Present" class="Present">Present</option>
                        <option value="Absent" class="Absent">Absent</option>
                        <option value="Half Day" class="Half-Day">Half Day</option>
                        <option value="Leave" class="Leave">Leave</option>
                        <option value="Holiday" class="Holiday">Holiday</option>
                    </select>
                </div>

                <div class="filter-group">
                    <button id="filterBtn" class="btn-filter w-100">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </div>
            </div>

            <div style="overflow-x: auto; padding: 20px;">
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Day</th>
                            <th>Lecture</th>
                            <th>Course</th>
                            <th>Status</th>
                            <th>Marked By</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceData">
                        <!-- Attendance data will be loaded here -->
                    </tbody>
                </table>

                <div style="margin-top:10px;">
                    {% if page_obj.has_previous %}
                    <a
                        href="?page={{ page_obj.previous_page_number }}&course={{ course }}&roll_no={{ roll_no }}&q={{ query }}">Previous</a>
                    {% endif %}

                    <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

                    {% if page_obj.has_next %}
                    <a
                        href="?page={{ page_obj.next_page_number }}&course={{ course }}&roll_no={{ roll_no }}&q={{ query }}">Next</a>
                    {% endif %}
                </div>


                <div id="noRecords" class="no-records" style="display: none;">
                    <i class="fas fa-search fa-2x mb-3"></i>
                    <p>No attendance records found for selected filters</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            const studentId = "{{ student.id }}";

            // Auto-dismiss alerts after 5 seconds
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);

            // Load attendance data
            function loadAttendanceData() {
                const course = $('#course').val();
                const month = $('#month').val();
                const year = $('#year').val();
                const status = $('#status').val();

                $('#filterBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');

                $.get('/get_student_attendance/', {
                    student_id: studentId,
                    course: course,
                    month: month,
                    year: year,
                    status: status
                }, function (data) {
                    const tbody = $('#attendanceData');
                    tbody.empty();

                    if (data.attendance.length === 0) {
                        $('#noRecords').show();
                    } else {
                        $('#noRecords').hide();

                        data.attendance.forEach(record => {
                            const date = new Date(record.date);
                            const day = date.toLocaleDateString('en-US', { weekday: 'long' });
                            const formattedDate = date.toLocaleDateString('en-GB');
                            const formattedTime = record.time || 'N/A';

                            const row = `
                                <tr>
                                    <td>${formattedDate}</td>
                                    <td>${day}</td>
                                    <td>Lecture ${record.lecture_number}</td>
                                    <td>${record.course_name}</td>
                                    <td class="status-${record.status.toLowerCase().replace(' ', '-')}" >
                                        ${record.status}
                                    </td>
                                    <td>Dr.${record.faculty_name}</td>
                                    <td>${formattedTime}</td>
                                </tr>
                            `;
                            tbody.append(row);
                        });

                        // Update summary cards
                        $('#total-lectures').text(data.summary.total_lectures);
                        $('#present-count').text(data.summary.present);
                        $('#absent-count').text(data.summary.absent);
                        $('#attendance-percent').text(data.summary.attendance_percentage + '%');
                    }
                }).fail(function (xhr) {
                    let errorMsg = 'Failed to load attendance data';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMsg = response.error || errorMsg;
                    } catch (e) { }

                    // Show error message
                    const alertHtml = `
                        <div class="alert alert-danger alert-dismissible fade show">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            ${errorMsg}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    $('.enroll-header').after(alertHtml);

                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        $('.alert').alert('close');
                    }, 5000);
                }).always(function () {
                    $('#filterBtn').prop('disabled', false).html('<i class="fas fa-filter"></i> Filter');
                });
            }

            // Filter button click
            $('#filterBtn').click(loadAttendanceData);

            // Handle Enter key in filter fields
            $('.filter-group select').keypress(function (e) {
                if (e.which === 13) {
                    loadAttendanceData();
                }
            });

            // Initial load
            loadAttendanceData();
        });
    </script>
</body>

</html>