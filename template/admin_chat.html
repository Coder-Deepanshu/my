{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="chat-container">
    <div class="chat-sidebar">
        <div class="chat-tabs">
            <button class="tab-button active" onclick="openTab('students')">Students</button>
            <button class="tab-button" onclick="openTab('faculties')">Faculty</button>
        </div>
        
        <div id="studentsTab" class="tab-content">
            <div class="chat-header">
                <h3>Students</h3>
                <div class="search-box">
                    <input type="text" placeholder="Search students..." id="studentSearch">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="user-list" id="studentList">
                {% for student in students %}
                <div class="user-item" data-user-id="{{ student.college_id }}" onclick="startChat('{{ student.college_id }}', 'student')">
                    <div class="user-avatar">
                        {% if student.profile_picture %}
                        <img src="{{ student.profile_picture.url }}" alt="{{ student.name }}">
                        {% else %}
                        <img src="{% static 'images/default-avatar.png' %}" alt="{{ student.name }}">
                        {% endif %}
                    </div>
                    <div class="user-info">
                        <h4>{{ student.name }}</h4>
                        <p>{{ student.course }} - {{ student.college_id }}</p>
                    </div>
                    <div class="user-status online"></div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div id="facultiesTab" class="tab-content" style="display:none;">
            <div class="chat-header">
                <h3>Faculty</h3>
                <div class="search-box">
                    <input type="text" placeholder="Search faculty..." id="facultySearch">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="user-list" id="facultyList">
                {% for faculty in faculties %}
                <div class="user-item" data-user-id="{{ faculty.college_id }}" onclick="startChat('{{ faculty.college_id }}', 'faculty')">
                    <div class="user-avatar">
                        {% if faculty.profile_picture %}
                        <img src="{{ faculty.profile_picture.url }}" alt="{{ faculty.name }}">
                        {% else %}
                        <img src="{% static 'images/default-avatar.png' %}" alt="{{ faculty.name }}">
                        {% endif %}
                    </div>
                    <div class="user-info">
                        <h4>{{ faculty.name }}</h4>
                        <p>{{ faculty.department }} - {{ faculty.position }}</p>
                    </div>
                    <div class="user-status online"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="chat-main">
        <div class="chat-header">
            <div class="chat-partner-info" id="chatPartnerInfo">
                <div class="partner-avatar">
                    <img src="{% static 'images/default-avatar.png' %}" alt="Select a user" id="partnerAvatar">
                </div>
                <div class="partner-details">
                    <h3 id="partnerName">Select a user to chat</h3>
                    <p id="partnerDetails"></p>
                </div>
                <div class="partner-status" id="partnerStatus"></div>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="no-chat-selected">
                <i class="fas fa-comments"></i>
                <p>Select a user to start chatting</p>
            </div>
        </div>
        
        <div class="chat-input" id="chatInput" style="display: none;">
            <textarea id="messageInput" placeholder="Type your message here..."></textarea>
            <button id="sendButton" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
    let currentRoomId = null;
    let currentPartnerId = null;
    let currentPartnerType = null;
    let currentUserId = "AD20250"; // Admin ID
    
    function openTab(tabName) {
        const tabContents = document.getElementsByClassName('tab-content');
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].style.display = 'none';
        }
        
        const tabButtons = document.getElementsByClassName('tab-button');
        for (let i = 0; i < tabButtons.length; i++) {
            tabButtons[i].classList.remove('active');
        }
        
        document.getElementById(tabName + 'Tab').style.display = 'block';
        event.currentTarget.classList.add('active');
    }
    
    function startChat(partnerId, partnerType) {
        currentPartnerId = partnerId;
        currentPartnerType = partnerType;
        
        // Fetch partner details
        const endpoint = partnerType === 'student' ? '/get_student_details/' : '/get_faculty_details/';
        
        fetch(`${endpoint}?${partnerType}_id=${partnerId}`)
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    const partner = data[partnerType];
                    
                    // Update UI with partner info
                    document.getElementById('partnerName').textContent = partner.name;
                    
                    if(partnerType === 'student') {
                        document.getElementById('partnerDetails').textContent = 
                            `${partner.course} - Sem ${partner.semester} (${partner.college_id})`;
                    } else {
                        document.getElementById('partnerDetails').textContent = 
                            `${partner.department} - ${partner.position}`;
                    }
                    
                    if(partner.profile_picture) {
                        document.getElementById('partnerAvatar').src = partner.profile_picture;
                    }
                    
                    // Show chat input
                    document.getElementById('chatInput').style.display = 'block';
                    
                    // Create or get chat room
                    fetch('/create_chat_room/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            participant1: currentUserId,
                            participant2: partnerId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.status === 'success') {
                            currentRoomId = data.room_id;
                            loadMessages(data.room_id);
                            
                            // Start polling for new messages
                            setInterval(() => {
                                loadMessages(currentRoomId);
                            }, 3000);
                        }
                    });
                }
            });
    }
    
    function loadMessages(roomId) {
        fetch(`/get_messages/${roomId}/`)
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';
                    
                    data.messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${message.sender === currentUserId ? 'sent' : 'received'}`;
                        
                        messageDiv.innerHTML = `
                            <div class="message-content">
                                <p>${message.content}</p>
                                <span class="message-time">${message.timestamp}</span>
                            </div>
                        `;
                        
                        messagesContainer.appendChild(messageDiv);
                    });
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            });
    }
    
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if(message && currentRoomId) {
            fetch('/send_message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    room_id: currentRoomId,
                    sender_id: currentUserId,
                    content: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    messageInput.value = '';
                    loadMessages(currentRoomId);
                }
            });
        }
    }
    
    // Search functionality
    document.getElementById('studentSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const studentItems = document.querySelectorAll('#studentList .user-item');
        
        studentItems.forEach(item => {
            const studentName = item.querySelector('h4').textContent.toLowerCase();
            if(studentName.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    document.getElementById('facultySearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const facultyItems = document.querySelectorAll('#facultyList .user-item');
        
        facultyItems.forEach(item => {
            const facultyName = item.querySelector('h4').textContent.toLowerCase();
            if(facultyName.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Allow pressing Enter to send message
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
{% endblock %}